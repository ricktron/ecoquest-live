name: EQL Ingest and Score
on: { workflow_dispatch: {}, push: { branches: [ main, bronze-* ] } }
jobs:
  run:
    runs-on: ubuntu-latest
    env:
      DB_URL: ${{ secrets.DB_URL }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Install psql
        uses: ankane/setup-postgres@v1
      - name: Ingest
        run: psql "$DB_URL" -v ON_ERROR_STOP=1 -c "select public.ingest_active_run();"
      - name: Compute
        run: psql "$DB_URL" -v ON_ERROR_STOP=1 -c "select public.compute_scores_mvp();"
      - name: Refresh Leaderboard MV
        run: |
          curl -sS -X POST -H "apikey: $SUPABASE_SERVICE_KEY" -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
          "$SUPABASE_URL/rest/v1/rpc/refresh_leaderboard_overall_mv"
      - name: Audit (RLS/perf)
        run: psql "$DB_URL" -v ON_ERROR_STOP=1 -c "select * from public.assert_security_and_perf_ok();"
      - name: Sanity SQL
        run: |
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_leaderboard.sql
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_bingo.sql
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_streaks.sql
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_trophies.sql
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_rarity.sql
          psql "$DB_URL" -v ON_ERROR_STOP=1 -f sql/sanity_bronze.sql
      - name: Snapshot Leaderboard
        run: psql "$DB_URL" -A -F, -c "copy (select * from public.leaderboard_overall_latest_v1) to stdout csv header" > leaderboard_snapshot.csv
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with: { name: leaderboard_snapshot, path: leaderboard_snapshot.csv }
